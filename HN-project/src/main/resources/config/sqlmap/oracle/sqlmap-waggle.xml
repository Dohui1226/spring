<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="waggle.WaggleDAO">

<!-- 가입하기 -->
<select id="join" statementType="CALLABLE" parameterType="wagglejoinVO">
 call join( #{member_id},#{nickname}, #{member_account})


</select>

<!-- 가입여부 ?? -->
<select id="joincheck" parameterType="wagglejoinVO" resultType="int">
select count(*) from hn_waggle where member_id=#{member_id}
</select>

<!-- 와글 등록할 정보 가져오기 -->
<select id="waggle" parameterType="memberVO" resultType="wagglejoinVO">
select * from hn_waggle where member_id=#{member_id}
</select>

<!-- 하트갯수 조회 -->
<select id="heartselect" parameterType="wagglejoinVO" resultType="int">
select heart from hn_waggle where no=#{no} 
</select>

<!-- 하트충전 -->
<select id="addheart" statementType="CALLABLE" parameterType="addheartVO">
call addheart(#{heart}, #{no},#{money}, #{anum})
</select>

<!--하트 보내기(교환)-->
<select id="changeheart" statementType="CALLABLE" parameterType="changeheartVO">
call changeheart(#{tono},#{fromno},#{heart})
</select>

<!--  쿠폰교환  -->
<select id="change" statementType="CALLABLE" parameterType="couponVO">
call changecoupon(#{coupontype},#{couponid},#{no},#{heart},#{couponname})
</select>

<!-- 쿠폰삭제 -->
<select id="deletecoupon" parameterType="couponVO">
delete from hn_coupon where coupon_id=#{couponid}
</select>
<!-- 쿠폰조회 -->
<select id="selectcoupon" parameterType="int" resultType="couponVO">
select * from hn_coupon where no=#{no}
</select>


<!-- 와글와글 수익률 기준 랭킹조회 -->
<select id="wagglerank" resultType="ranklistVO">
select rate, stockvalue,no,nickname,hart,
rank() over(order by rate desc) rank from(select a.rate ,a.stockvalue,b.no, b.nickname, b.hart from hn_waggle b , 
(select * from (SELECT acc_num,rate, stockvalue,
RANK() OVER (PARTITION BY acc_num ORDER BY no DESC) AS RANK
FROM acc_daily) where rank=1) a
where b.member_account = a.acc_num) order by rank
</select>

<!-- 나의등수및 수익률과 포트폴리오보기 -->
<select id="myrank" resultType="ranklistVO" parameterType="wagglejoinVO">
select rate, stockvalue,no,nickname,hart,rank from(select rate, stockvalue,no,nickname,hart,
rank() over(order by rate desc) rank from(select a.rate ,a.stockvalue,b.no, b.nickname, b.hart from hn_waggle b , 
(select * from (SELECT acc_num,rate, stockvalue,
RANK() OVER (PARTITION BY acc_num ORDER BY no DESC) AS RANK
FROM acc_daily) where rank=1) a
where b.member_account = a.acc_num) order by rank) where no=#{no}
</select>






<!-- 계좌번호조회 -->
<select id="selectaccount" parameterType="waggleJoinVO" resultType="waggleJoinVO">
select * from hn_waggle where no=#{no}
</select>

<!-- 계좌당 가지고 있는 종목타입별 가치 및 비중-->
<select id="stockweight" resultType="stockweightVO" parameterType="wagglejoinVO">
select value, stock_type, ratio_to_report(value) over() valuerate from (select sum(stock_value*stock_num)as value ,stock_type from (select a.stock_value, a.stock_num, 
b.stock_type from buystock a join (select c.stock_code,c.stock_close,c.close_date, c.stock_name,
k.stock_type from (select * from(select * from hn_stock_close order by close_date desc)
where<![CDATA[rownum <=40]]>) c,hn_stock_code k where c. stock_code=k.stock_code) b
on  a.acc_num=#{member_account} and a.stock_code=b.stock_code) group by stock_type) order by value desc
</select>

<!-- 계좌번호와 타입입력하면 금액이랑 종목코드 매입가격알려줌 -->
<select id="typecompany" resultType="mystockVO" parameterType="buysellVO">
select b.stock_name, a.stock_value, a.stock_num, a.buyprice from hn_stock_code b,
(select *from buystock where acc_num =#{member_account} order by bdate desc) a where b.stock_type=#{stock_type}
and b.stock_code=a.stock_code
</select>

<!-- 계좌별 -100일치 수익률 -->
<select id="selectrateaccount">
select wdate,rate from acc_daily where no in 
(select max(no) from (select * from acc_daily where dayupdate='t' and acc_num=#{member_account} and wdate between sysdate-100 and sysdate)
group by wdate)
</select>



<!-- 100일전까지 날짜조회하기 -->
<select id="selectdate">
select close_date from hn_stock_close where close_date between sysdate-100 and sysdate
group by close_date order by close_date
</select>
</mapper>


